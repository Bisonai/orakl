name: Dispatch Deploy
on:
  workflow_dispatch:
    inputs:
      network:
        description: "Network"
        required: true
        type: choice
        options:
          - "Baobab"
          - "Cypress"
      application:
        description: "Service"
        required: true
        type: choice
        options:
          - "cli"
          - "vrf"
          - "api"
          - "request-response"
          - "delegator"
          - "por"
          - "node"
          - "boot-api"
          - "sentinel"
          - "dal"
          - "reporter"
          - "logscribe"
      image:
        description: "Image Version"
        required: true
        type: choice
        default: "new"
        options:
          - new
          - node:v0.0.1.20240708.0832.1a4d08d:OraklNode Define new chainhelp...
          - dal:v0.0.1.20240708.0944.4aa3dd7:DAL basic implementation to st...
          - node:v0.0.1.20240708.0954.0d869fa:OraklNode Rollback deviation t...
          - dal:v0.0.1.20240708.1003.920fd73:OraklNode Rollback deviation t...
          - dal:v0.0.1.20240708.1019.8328517:DAL APIKEY from secrets
          - sentinel:v0.0.1.20240709.0109.fa6cdc8:Sentinel remove datafeed redis...
          - sentinel:v0.0.1.20240709.0259.02a3c94:sentinel oversubmission in che...
          - node:v0.0.1.20240709.0426.36beb1a:OraklNode Remove lint  vet fro...
          - node:v0.0.1.20240709.0540.1c4a79b:OraklNode Remove lint  vet fro...
          - dal:v0.0.1.20240709.0802.c7cffb3:OraklNode Remove unused functi...
          - dal:v0.0.1.20240710.0242.a84f50c:DAL Add log for debugging
          - node:v0.0.1.20240710.0520.98648d0:fix type in SubmissionProxy mi...
          - node:v0.0.1.20240710.0739.4a70b71:remove pool integration from a...
          - dal:v0.0.1.20240711.0359.d657755:DAL Use separate db
          - dal:v0.0.1.20240712.0249.40a95d7:Add new option to deployment s...
          - dal:v0.0.1.20240712.0440.f9d9bd8:DAL Add description column to ...
          - node:v0.0.1.20240712.0451.9550617:DAL Add description column to ...
          - sentinel:v0.0.1.20240712.0745.072c71b:update sentinel signer expiry ...
          - sentinel:v0.0.1.20240712.1116.3b29b6c:update sentinel signer expiry ...
          - sentinel:v0.0.1.20240715.0443.6e850cb:fix oversubmission query times...
          - node:v0.0.1.20240715.0528.483b568:fix oversubmission query times...
          - node:v0.0.1.20240715.0716.fa898e4:Update auto tag doc generation
          - boot-api:v0.0.1.20240715.0740.ee80d13:Update auto tag doc generation
          - boot-api:v0.0.1.20240715.0937.9b09599:BootAPI Keep boot host alive
          - boot-api:v0.0.1.20240716.0831.b209fc6:Sentinel Group feed checks by ...
          - sentinel:v0.0.1.20240716.0840.291dccb:Sentinel Group feed checks by ...
          - sentinel:v0.0.1.20240716.0851.ac68b4d:Add logs for peer checks
          - node:v0.0.1.20240716.1308.a16e0b7:OraklNode Hotfix filter out in...
          - sentinel:v0.0.1.20240717.0112.b9db8f2:Sentinel Remove deprecated res...
          - dal:v0.0.1.20240717.0230.301dcf3:Sentinel Remove deprecated res...
          - dal:v0.0.1.20240717.0302.8b595e7:add ctx logs to dal middleware
          - dal:v0.0.1.20240717.0409.0f36d29:allow free pass for health che...
          - node:v0.0.1.20240717.0605.5ed1c01:Rollback utils
          - api:v0.0.1.20240717.0835.d1cde6f:Remove aggregator and fetcher ...
          - api:v0.0.1.20240717.0848.f15e4a1:API Remove unused redis refere...
          - sentinel:v0.0.1.20240718.0315.c7556ec:SentinelUpdate dal port for he...
          - dal:v0.0.1.20240722.0145.98e63ea:DAL Simplify api endpoint
          - sentinel:v0.0.1.20240722.0150.c79d9e5:DAL Simplify api endpoint
          - sentinel:v0.0.1.20240722.0436.aef4892:downgrade some info logs to de...
          - sentinel:v0.0.1.20240722.0508.94de629:Sentinel Update sentinel dal a...
          - node:v0.0.1.20240722.0528.ea7bf6b:Sentinel Update sentinel dal a...
          - dal:v0.0.1.20240722.0657.d3a3573:allow trailing comma in data r...
          - node:v0.0.1.20240722.0706.f1a55cf:allow trailing comma in data r...
          - dal:v0.0.1.20240722.0817.38afd9c:fix empty data return issue in...
          - node:v0.0.1.20240723.0522.5225c8e:OraklNode Increase delegator t...
          - node:v0.0.1.20240723.0539.d618b6b:OraklNode Increase delegator t...
          - node:v0.0.1.20240723.0546.3736b1f:Revert OraklNode Implement man...
          - dal:v0.0.1.20240723.0713.3684c42:Potential fix for concurrent w...
          - dal:v0.0.1.20240723.0950.f26c52f:DAL hotfix mutex implementatio...
          - delegator:v0.0.1.20240724.0615.951a25d:Delegator delegator sign funct...
          - node:v0.0.1.20240725.0309.d5a2c89:DAL Minor update
          - delegator:v0.0.1.20240725.0310.d5a2c89:DAL Minor update
          - delegator:v0.0.1.20240725.0348.bb6b5ab:Delegator Fix grafana not visu...
          - dal:v0.0.1.20240725.0608.3c62dcb:Return hexstring for bytes typ...
          - reporter:v0.0.1.20240729.0535.9951bc8:OraklNode Update intervals
          - reporter:v0.0.1.20240729.0601.c47cac1:remove db dependency from repo...
          - reporter:v0.0.1.20240729.0617.71e4260:Reporter Remove additional pro...
          - node:v0.0.1.20240729.0629.7671f73:Reporter Remove additional pro...
          - sentinel:v0.0.1.20240729.0632.d94d2c1:Reporter Remove additional pro...
          - sentinel:v0.0.1.20240729.0701.5968549:remove admin wallet endpoint f...
          - sentinel:v0.0.1.20240729.0709.d749c0c:fix reporter endpoint
          - reporter:v0.0.1.20240729.0722.0661431:remove trailing slash
          - sentinel:v0.0.1.20240729.0734.8a64d46:remove trailing slash
          - sentinel:v0.0.1.20240729.0744.b3448bb:Sentinel Update sentinel with ...
          - dal:v0.0.1.20240729.0821.0bc41a5:Sentinel Update sentinel with ...
          - dal:v0.0.1.20240729.0857.1e70d2e:DAL Hotfix add missing threadi...
          - dal:v0.0.1.20240729.1006.3081fa7:DAL Hotfix mutex lock duplicat...
          - dal:v0.0.1.20240729.1032.5dcc456:DAL Quick return from client h...
          - dal:v0.0.1.20240730.0325.afa71cc:log timestamps for pairs in da...
          - dal:v0.0.1.20240730.0342.152a6dd:udpate dal collector info logs...
          - node:v0.0.1.20240730.0346.f01799b:OraklNode Remove bulk rdb inse...
          - node:v0.0.1.20240730.0517.f63c184:measure accumulatorJob executi...
          - node:v0.0.1.20240730.0643.dba5faa:OraklNode Use message bus for ...
          - node:v0.0.1.20240730.0717.328c4df:OraklNode Remove time validati...
          - node:v0.0.1.20240730.0746.de0a795:OraklNode add aggregator logs
          - dal:v0.0.1.20240730.0821.882e4ac:DAL Print log
          - dal:v0.0.1.20240730.0839.8ff2ec2:DAL Update buffer
          - node:v0.0.1.20240731.0147.daed99b:OraklNode log redis latency
          - dal:v0.0.1.20240731.0150.45c94d9:OraklNode log redis latency
          - reporter:v0.0.1.20240731.0251.36d5b48:Reporter add delay log
          - reporter:v0.0.1.20240731.0254.5eb7fab:Reporter add delayed submissio...
          - reporter:v0.0.1.20240731.0340.77015eb:Reporter Thread submission fro...
          - reporter:v0.0.1.20240731.0430.9bf0e75:Reporter wg update
          - dal:v0.0.1.20240731.0436.0039a2f:update redis delay log
          - dal:v0.0.1.20240731.0514.5da3ce6:update redis delay log
          - dal:v0.0.1.20240731.0531.4e0cafc:update redis delay log
          - dal:v0.0.1.20240731.0605.aae343e:Reporter Rest reporter
          - reporter:v0.0.1.20240731.0607.67a5dd3:Reporter Rest reporter
          - node:v0.0.1.20240801.0345.e8a1d52:OraklNode Add condition to inc...
          - sentinel:v0.0.1.20240801.0350.f515ac9:fix go mod tidy
          - dal:v0.0.1.20240801.0357.fd16df0:fix go mod tidy
          - reporter:v0.0.1.20240801.0521.9e654a8:OraklNode Handle nonce error
          - dal:v0.0.1.20240801.0522.fcbfdcd:OraklNode Handle nonce error
          - reporter:v0.0.1.20240801.0539.66f274d:OraklNode error is not being c...
          - node:v0.0.1.20240801.0647.836356c:add data delay logs to node an...
          - dal:v0.0.1.20240801.0651.633694f:add data delay logs to node an...
          - node:v0.0.1.20240801.0703.862980f:rollback node and dal data del...
          - dal:v0.0.1.20240801.0727.248258e:rollback node and dal data del...
          - reporter:v0.0.1.20240801.0750.b725976:Sentinel Update threshold to r...
          - sentinel:v0.0.1.20240801.0753.169c3c9:Sentinel Update threshold to r...
          - sentinel:v0.0.1.20240801.0907.c3a64db:Sentinel Change threshold to r...
          - sentinel:v0.0.1.20240802.0153.63a109c:OraklNode Mutex lock instead o...
          - dal:v0.0.1.20240802.0156.df96ad7:OraklNode Mutex lock instead o...
          - node:v0.0.1.20240802.0200.b20a5c6:OraklNode Mutex lock instead o...
          - dal:v0.0.1.20240802.0301.e8ff73c:DAL dal logs for debugging
          - dal:v0.0.1.20240802.0426.303cd85:DAL Prevent possible race cond...
          - dal:v0.0.1.20240802.0554.e60151d:DAL Fix ws deadlock
          - sentinel:v0.0.1.20240802.0656.c31b1af:Sentinel Alarm count offset fo...
          - sentinel:v0.0.1.20240802.0722.815e34a:Sentinel Initialize count if i...
          - dal:v0.0.1.20240802.0737.d1641c9:DAL Prevent deadlock from mult...
          - dal:v0.0.1.20240802.0814.2366d70:DAL definite unlock through de...
          - dal:v0.0.1.20240802.0902.33bad15:DAL definite unlock through de...
          - node:v0.0.1.20240805.0142.77d6df9:DAL Chore minor dal optimizati...
          - dal:v0.0.1.20240805.0149.18cb534:DAL Chore minor dal optimizati...
          - node:v0.0.1.20240805.0419.cadaade:OraklNode Offchain Proof and T...
          - dal:v0.0.1.20240805.0421.cadaade:OraklNode Offchain Proof and T...
          - logscribe:v0.0.1.20240805.0548.4a1cddf:Contract Deploy cypress submis...
          - logscribe:v0.0.1.20240805.0558.ee14074:Contract Deploy cypress submis...
          - logscribe:v0.0.1.20240805.0615.4fde42a:Contract Deploy cypress submis...
          - logscribe:v0.0.1.20240805.0639.4d0df4b:Contract Deploy cypress submis...
          - node:v0.0.1.20240805.0858.7647cf1:OraklNode Minor updates add em...
          - dal:v0.0.1.20240805.0904.8bc24f7:OraklNode Minor updates add em...
          - dal:v0.0.1.20240805.1011.e61e2a9:DAL update log
          - node:v0.0.1.20240807.0149.4005140:OraklNode Msg replay preventio...
          - node:v0.0.1.20240807.0233.c512afe:OraklNode Mutex lock roundID
          - node:v0.0.1.20240807.0400.5926df7:OraklNode Rollback raft msg re...
          - node:v0.0.1.20240807.0514.6907ece:OraklNode Admin add fallback t...
jobs:
  prepare-taskflow:
    name: Prepare
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.image != 'new' }}
    outputs:
      service: ${{ steps.tag.outputs.service }}
      version: ${{ steps.package.outputs.version }}
      tag_date: ${{ steps.taskflow-tag.outputs.tag_date }}
      tag_git_hash: ${{ steps.taskflow-tag.outputs.tag_git_hash}}
      img_tag: ${{ steps.taskflow-tag.outputs.img_tag }}
    steps:
      - uses: actions/checkout@master
      - name: extract tags
        id: taskflow-tag
        run: "IMAGE_TAG=\"${{ github.event.inputs.image }}\"\nVERSION=$(echo \"${IMAGE_TAG}\" | cut -d':' -f2 | cut -d'.' -f1-3)\necho $VERSION\nTAG_DATE=$(echo \"${IMAGE_TAG}\" | cut -d':' -f2 | cut -d'.' -f4-5)\necho $TAG_DATE\nTAG_GIT_HASH=$(echo \"${IMAGE_TAG}\" | cut -d':' -f2 | cut -d'.' -f6)\nTAG=\"${VERSION}.${TAG_DATE}.${TAG_GIT_HASH}\"\necho $TAG;          \necho $TAG_GIT_HASH\necho \"version=${VERSION}\" >> $GITHUB_OUTPUT\necho \"tag_date=${TAG_DATE}\" >> $GITHUB_OUTPUT\necho \"tag_git_hash=${TAG_GIT_HASH}\" >> $GITHUB_OUTPUT\necho \"img_tag=${TAG}\" >> $GITHUB_OUTPUT\n"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
  taskflow-image-update:
    name: Update Image Tag
    needs: [prepare-taskflow]
    uses: ./.github/workflows/update.image-tag.yaml
    with:
      network: "baobab"
      build: false
      project-name: ${{ github.event.inputs.application }}
      version: ${{ needs.prepare-taskflow.outputs.version }}
      image-tag: ${{ needs.prepare-taskflow.outputs.img_tag}}
      tag_date: ${{ needs.prepare-taskflow.outputs.tag_date }}
      tag_git_hash: ${{ needs.prepare-taskflow.outputs.tag_git_hash }}
    secrets:
      PAT: ${{ secrets.PAT }}
    if: ${{ github.event.inputs.image != 'new' }}
  post-slack-taskflow-image-upload:
    name: Slack message for image upload
    needs: [prepare-taskflow, taskflow-image-update]
    uses: ./.github/workflows/post.slack.yaml
    with:
      status: "Success"
      slack-message: "${{ github.event.inputs.network }} ${{ github.event.inputs.application }}* : *${{ needs.prepare-taskflow.outputs.img_tag}}* is updated"
      channel: "orakl-notification"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    if: ${{ github.event.inputs.network == 'Baobab' && success() }}
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.network == 'Baobab' && github.event.inputs.image == 'new' }}
    outputs:
      tag_date: ${{ steps.tag.outputs.date }}
      tag_git_hash: ${{ steps.tag.outputs.git_hash }}
      service: ${{ steps.tag.outputs.service }}
      ecr_url: ${{ steps.tag.outputs.ecr_url }}
      version: ${{ steps.package.outputs.version }}
    steps:
      - uses: actions/checkout@master
      - name: get time tag
        id: tag
        run: "# Get the date and git hash\necho \"date=$(date +'%Y%m%d.%H%M')\" >> $GITHUB_OUTPUT\necho \"git_hash=$(git rev-parse --short HEAD)\" >> $GITHUB_OUTPUT\nservice=\"${{ github.event.inputs.application }}\"\n# Set the service name\nif [[ \"$service\" == \"vrf\" || \"$service\" == \"request-response\" ]]; then\n  service=\"core\"\nfi            \n# Set the ecr url\necho \"service=$service\" >> $GITHUB_OUTPUT\necho \"ecr_url=public.ecr.aws/bisonai/orakl-${service}\" >> $GITHUB_OUTPUT\n# end of the script\n"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
      - name: get package version
        id: package
        run: "# Get the version from the package.json file\nif [[ \"${{ steps.tag.outputs.service }}\" == \"cli\" || \"${{ steps.tag.outputs.service }}\" == \"core\" ]]; then  \necho \"version=$(node -p -e \"require('./\"${{ steps.tag.outputs.service }}\"/package.json').version\")\" >> $GITHUB_OUTPUT\nelse \n  if [[ \"${{ steps.tag.outputs.service }}\" == \"boot-api\" || \"${{ steps.tag.outputs.service }}\" == \"node\" || \"${{ steps.tag.outputs.service }}\" == \"por\" || \"${{ steps.tag.outputs.service }}\" == \"dal\" || \"${{ steps.tag.outputs.service }}\" == \"reporter\" || \"${{ steps.tag.outputs.service }}\" == \"logscribe\" ]]; then    \n    version=$(cat ./node/.version)  \n  else\n    version=$(cat ./${{ steps.tag.outputs.service }}/.version)\n  fi\n  echo \"version=$version\" >> $GITHUB_OUTPUT\nfi\n"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.network == 'Baobab' && github.event.inputs.image == 'new' }}
    permissions:
      id-token: write
      contents: read
    outputs:
      img_tag: ${{ steps.img-tag.outputs.img_tag }}
    steps:
      - uses: actions/checkout@master
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.3"
          check-latest: true
          cache-dependency-path: |
            ./${{ needs.prepare.outputs.service }}/go.sum
            ./${{ needs.prepare.outputs.service }}/go.mod
        if: ${{ needs.prepare.outputs.service != 'core' || needs.prepare.outputs.service != 'fetcher' || needs.prepare.outputs.service != 'cli' }}
      - name: docker build ${{ github.event.inputs.application }}
        run: SERVICE_NAME=orakl-${{ needs.prepare.outputs.service }} docker compose -f docker-compose.build.yaml build
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.ROLE_ARN }}
      - name: login to amazon ecr
        id: login-ecr-public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public
      - name: publish image to ecr
        run: |
          docker tag orakl-${{ needs.prepare.outputs.service }} ${{ needs.prepare.outputs.ecr_url }}:latest
          docker push ${{ needs.prepare.outputs.ecr_url }}:latest
          docker tag ${{ needs.prepare.outputs.ecr_url }}:latest ${{ needs.prepare.outputs.ecr_url }}:v${{ needs.prepare.outputs.version }}.${{ needs.prepare.outputs.tag_date }}.${{ needs.prepare.outputs.tag_git_hash }}
          docker push ${{ needs.prepare.outputs.ecr_url }}:v${{ needs.prepare.outputs.version }}.${{ needs.prepare.outputs.tag_date }}.${{ needs.prepare.outputs.tag_git_hash }}
      - name: image tag output
        id: img-tag
        run: echo "img_tag=v${{ needs.prepare.outputs.version }}.${{ needs.prepare.outputs.tag_date }}.${{ needs.prepare.outputs.tag_git_hash }}" >> $GITHUB_OUTPUT
  post-slack-image-upload:
    name: Slack message for image upload
    needs: [prepare, build]
    uses: ./.github/workflows/post.slack.yaml
    with:
      status: "Success"
      slack-message: "${{ github.event.inputs.network }} ${{ github.event.inputs.application }}* : *${{ needs.prepare.outputs.service }}* ${{ needs.prepare.outputs.version }}.${{ needs.prepare.outputs.tag_date }}.${{ needs.prepare.outputs.tag_git_hash }} is uploaded"
      channel: "orakl-notification"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    if: ${{ github.event.inputs.network == 'Baobab' && success() }}
  image-update:
    name: Update image tag
    needs: [prepare, build]
    uses: ./.github/workflows/update.image-tag.yaml
    with:
      network: "baobab"
      project-name: ${{ github.event.inputs.application }}
      version: ${{ needs.prepare.outputs.version }}
      image-tag: ${{ needs.build.outputs.img_tag }}
      tag_date: ${{ needs.prepare.outputs.tag_date }}
      tag_git_hash: ${{ needs.prepare.outputs.tag_git_hash }}
    secrets:
      PAT: ${{ secrets.PAT }}
    if: ${{ github.event.inputs.network == 'Baobab' && github.event.inputs.image == 'new' }}
  post-slack-baobab-tag-update-success:
    name: Post slack message for tag update success
    needs: [prepare, build, image-update]
    uses: ./.github/workflows/post.slack.yaml
    with:
      status: "Success"
      slack-message: "${{ github.event.inputs.network }} *${{ github.event.inputs.application }}* : *${{ needs.prepare.outputs.service }}* new image tag ${{ needs.prepare.outputs.version }}.${{ needs.prepare.outputs.tag_date }}.${{ needs.prepare.outputs.tag_git_hash }} is updated"
      channel: "orakl-notification"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    if: ${{ github.event.inputs.network == 'Baobab' && github.event.inputs.image == 'new' && success() }}
  cypress-image-update:
    name: cypress image update
    uses: ./.github/workflows/update.image-tag.yaml
    with:
      network: "cypress"
      project-name: ${{ github.event.inputs.application }}
    secrets:
      PAT: ${{ secrets.PAT }}
    if: ${{ github.event.inputs.network == 'Cypress' }}
  post-slack-cypress-tag-update-success:
    name: Post slack message for tag update success
    needs: [cypress-image-update]
    uses: ./.github/workflows/post.slack.yaml
    with:
      status: "Success"
      slack-message: "${{ github.event.inputs.network }} *${{ github.event.inputs.application }}* is updated"
      channel: "orakl-notification"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    if: ${{ github.event.inputs.network == 'Cypress' && success() }}
  post-slack-tag-update-failure:
    name: Post to a slack message for tag update failure
    needs: [prepare, build, image-update]
    uses: ./.github/workflows/post.slack.yaml
    with:
      status: "Failed"
      slack-message: "${{ github.event.inputs.network }} *${{ github.event.inputs.application }}* git action failed"
      channel: "orakl-notification"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    if: ${{ github.event.inputs.network == 'Baobab' && github.event.inputs.image == 'new' && failure() }}
  update-workflow-and-readme:
    name: Update Workflow and README
    needs: [prepare, build, image-update]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pages: write
    outputs:
      new_tag: ${{ steps.tag_info.outputs.NEW_TAG }}
      pr_title: ${{ steps.pr_info.outputs.PR_TITLE }}
      truncated_title: ${{ steps.truncate_pr_title.outputs.truncated_title }}
    steps:
      - uses: actions/checkout@master
        with:
          token: ${{ secrets.WORKFLOW_PAT }}
      - name: get latest merged pull request
        id: pr_info
        run: |
          pr=$(gh pr list --state merged --json title -L 1)
          PR_TITLE=$(echo $pr | jq -r '.[0].title')
          PR_TITLE=$(echo "${PR_TITLE}" | sed 's/\\/\\\\/g; s/"/\\"/g; s/`/\\`/g; s/\$/\\$/g')
          PR_TITLE=$(echo "${PR_TITLE}" | sed 's/[^a-zA-Z0-9 ]//g')
          echo "PR_TITLE=${PR_TITLE}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
      - name: truncate PR title
        id: truncate_pr_title
        run: "TR_PR_TITLE=\"${{steps.pr_info.outputs.PR_TITLE}}\"\nMAX_LENGTH=30\nif [ ${#TR_PR_TITLE} -gt $MAX_LENGTH ]; then\n  TRUNCATED_TITLE=\"${TR_PR_TITLE:0:$MAX_LENGTH}...\"\nelse\n  TRUNCATED_TITLE=\"$TR_PR_TITLE\"\nfi\necho \"truncated_title=$TRUNCATED_TITLE\" >> $GITHUB_OUTPUT  \n"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
      - name: Update Workflow Dispatch Options
        id: tag_info
        run: |
          # Update the deployment.yaml file with the new tag
          git pull

          # Get the new tag
          NEW_TAG=${{ github.event.inputs.application }}:${{ needs.build.outputs.img_tag }}
          TAG_WITH_DESCRIPTION="${NEW_TAG}:${{ steps.truncate_pr_title.outputs.truncated_title }}"

          CURRENT_OPTIONS=$(yq e '.on.workflow_dispatch.inputs.image.options[]' .github/workflows/deployment.yaml | sed 's/^- //')
          OPTIONS_ARRAY=()

          while IFS= read -r line; do
            OPTIONS_ARRAY+=("\"$line\"")
          done <<< "$CURRENT_OPTIONS"

          OPTIONS_ARRAY+=("\"$TAG_WITH_DESCRIPTION\"")

          yq eval 'del(.on.workflow_dispatch.inputs.image.options)' -i .github/workflows/deployment.yaml

          for option in "${OPTIONS_ARRAY[@]}"; do
            yq eval ".on.workflow_dispatch.inputs.image.options += [$option]" -i .github/workflows/deployment.yaml
          done

          git add .github/workflows/deployment.yaml
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
      - name: Update TAGS with Latest PR Info
        run: |
          echo "- **${{ github.event.inputs.application }}** ${{ needs.build.outputs.img_tag }} <br> *\`PR\`*: ${{steps.truncate_pr_title.outputs.truncated_title}} <br><br> " >> TAGS.md
          git add TAGS.md
      - name: Commit & Push changes
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.WORKFLOW_PAT }}
          branch: ${{ github.ref }}
          repository: ${{ github.repository }}
  post-slack-pr-update:
    name: Post to a slack message for tag update failure
    needs: [prepare, build, image-update, update-workflow-and-readme]
    uses: ./.github/workflows/post.image.slack.yaml
    with:
      slack-message: "\\n \\n> *Service:* ${{ github.event.inputs.application }} \\n> *Version:* ${{ needs.build.outputs.img_tag }} \\n> *PR:* ${{ needs.update-workflow-and-readme.outputs.pr_title}}"
      channel: "orakl-images"
    secrets:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
    if: ${{ success() }}
