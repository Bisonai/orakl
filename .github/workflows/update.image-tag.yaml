name: "update-image-tag-in-helm-chart"

on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string
      version:
        required: true
        type: string
      image-tag:
        required: true
        type: string
    secrets:
      PAT:
        required: true        

jobs:
  update-image-tag:
    name: Update Image Tag
    runs-on: ubuntu-latest
    needs: build

    permissions:
      id-token: write
      contents: read 

    steps:

    - name: checkout gitops
      run: |
        echo Checking out ${GITHUB_SERVER_URL}/orakl-helm-charts.git
        rm -rf ./gitops_tmp

        GH_URL=$(echo "$GITHUB_SERVER_URL" | sed 's,://,://x-access-token:'"${{ secrets.PAT }}"'@,g')
        git clone --depth 1 ${GH_URL}/orakl-helm-charts.git ./gitops_tmp

      shell: bash

    - name: Update image tag in multiple values.baobab.yaml files
      run: |

        cd ./gitops_tmp/${{ inputs.project-name }}/values.baobab.yaml     

        echo "Updating image tag in values.baobab.yaml files"

        sed -i 's/tag: .*$/tag: "'${{ input.image-tag }}'"/g' baobab.values.yaml

        echo "Update App Version in Chart.yaml"
        sed -i 's/appVersion: .*$/appVersion: "'${{ inputs.version }}'"/g' Chart.yaml



      shell: bash

    - name: Push changes to gitops
      working-directory: ./gitops_tmp
      run: |
        echo Pushing changes to orakl-helm-charts
        git config user.name "GitHub Actions"
        git config user.email "infra@bisonai.com"     
        git stash
        git pull origin main
        git stash pop          
        git add .
        git commit --allow-empty -m "Deploy \"${{ input.image-tag }}\" imag tag update for \"${{ inputs.project-name }}\" project
        git push -u origin main
      shell: bash